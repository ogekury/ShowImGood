/*!
* busAPP - v0.0.1 - 2014-05-25
*/
dom={init:function(){$(".close").click(function(){dom.slideInOut()}),$("#txt").focus(function(){$(this).val("")}),$(".seemore").on("click",function(){return $(".time-res").fadeIn(),dom.seeMoreCtrl("close"),!1}),$(".seeall").on("click",function(){return $(".time-res").hide(),$(".time-res").fadeIn(),dom.seeAllCtrl("close"),!1})},clickOp:function(){this.close(),this.slideInOut()},close:function(){$("#results").hide()},slideInOut:function(){dom.seeAllCtrl("close"),$("#results").slideToggle("slow")},seeMoreCtrl:function(a){"open"===a?$(".seemore").fadeIn("slow"):"close"===a&&$(".seemore").hide()},seeAllCtrl:function(a){"open"===a?$(".seeall").fadeIn("slow"):"close"===a&&$(".seeall").hide()},searchError:function(a){var b="";switch(a){case"ZERO_RESULTS":var c=$("#txt").val();b="We could not find "+c+", please try again";break;case"NO_BUS_STOP":b="No bus stops in this location";break;default:b="Undefined error"}$(".error").html(b),$(".error").fadeIn()},hideError:function(){$(".error").hide()},subNav:function(a){dom.seeMoreCtrl("close"),$(".time-res").hide(),$("."+a).fadeIn(),dom.seeAllCtrl("open")}},$(document).ready(function(){map.init(),dom.init()});var map={url:"http://digitaslbi-id-test.herokuapp.com/bus-stops",send:null,reqType:"all",londonMap:null,stop:null,geocoder:null,mapMarkers:[],init:function(){map.send=this.url,map.loadMap(),$("#btn").click(function(){return map.locateAddress(),!1})},area:{northEast:"51.523858, -0.153594",southWest:"51.508208 , -0.081968"},mapOptions:{zoom:16,center:new google.maps.LatLng(51.51258,-.1366),mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]}},loadMap:function(){this.geocoder=new google.maps.Geocoder,this.londonMap=new google.maps.Map(document.getElementById("map"),map.mapOptions),google.maps.event.addListener(this.londonMap,"mouseup",function(){map.resetArea()}),this.apiRequest("initial",map.area)},apiRequest:function(a,b){$.ajax({dataType:"jsonp",type:"GET",url:map.send,data:b}).done(function(b,c){if("success"===c)switch(a){case"initial":map.populateMap(b.markers);break;case"stop":map.stopData(b)}return!1})},locateAddress:function(){dom.hideError(),dom.close();var a=document.getElementById("txt").value;map.geocoder.geocode({address:a},function(a,b){b===google.maps.GeocoderStatus.OK?(map.londonMap.setCenter(a[0].geometry.location),map.resetArea()):dom.searchError(b)})},resetArea:function(){map.area={northEast:map.londonMap.getBounds().getNorthEast().lat()+", "+map.londonMap.getBounds().getNorthEast().lng(),southWest:map.londonMap.getBounds().getSouthWest().lat()+", "+map.londonMap.getBounds().getSouthWest().lng()},map.cleanMap(),map.send=map.url,map.apiRequest("initial",map.area)},cleanMap:function(){for(var a=0;a<map.mapMarkers.length;a++)map.mapMarkers[a].setMap(null);map.mapMarkers=[]},populateMap:function(a){var b,c,d=new google.maps.InfoWindow,e="assets/images/busicon.png";if(void 0===a)return!1;if(a.length>0)for(c=0;c<a.length;c++)b=new google.maps.Marker({position:new google.maps.LatLng(a[c].lat,a[c].lng),map:map.londonMap,icon:e}),google.maps.event.addListener(b,"click",function(b,c){return function(){d&&d.close(),d.setContent(map.markerContent(a[c])),d.open(map.londonMap,b)}}(b,c)),map.mapMarkers[c]=b;else dom.searchError("NO_BUS_STOP");return!1},markerContent:function(a){dom.close(),dom.hideError(),map.send=null,map.send=map.url+"/"+a.id,map.apiRequest("stop",{}),map.stop=a.id;var b='<div class="marker-txt">'+a.name,c=a.routes;if(void 0!==c&&c.length>0){b+=" (towards: "+a.towards+")</br>Routes: ";for(var d=0;d<c.length;d++)b+=c[d].name+" ";b+="<br/>"}return b+="</div>",map.createSubNav(c),b},createSubNav:function(a){for(var b="",c=0;c<a.length;c++)b+="<a href=\"javascript:dom.subNav('"+a[c].name+"')\">"+a[c].name+"</a>&nbsp;";$("#numbers").html(b)},stopData:function(a){dom.seeMoreCtrl("close");var b="";if(void 0!==a.arrivals){var c,d=a.arrivals;if(d.length>0){for(b="<ul>",c=0;c<d.length;c++)b+=c>7?'<li class="time-res '+d[c].routeName+'" style="display:none;">':'<li class="time-res '+d[c].routeName+'">',b+='<span class="number">'+d[c].routeName+"</span>",b+='<span class="dest">Destination: '+d[c].destination+"</span>",b+=" estimated: "+d[c].estimatedWait,b+="</li>";b+="</ul>",c>8&&dom.seeMoreCtrl("open")}else b="Can't find bus info last update "+a.lastUpdated;$("#stops").html(b),dom.clickOp()}}};